# 文件结构
3FS 跟大多数分布式文件系统一样，将文件分为元数据与块存储两个部分。元数据由元数据服务器集群提供服务，块存储由存储服务器集群提供服务。

## 元数据服务
负责管理文件系统的元数据信息，为用户提供文件系统语义的实现。这些元数据是描述文件和目录的属性和结构的数据，不包含文件的实际内容。

### 元数据存储
使用分布式数据库 FoundationDB 存储。   

**Inode**
与 Linux 文件系统基本一致，3FS 使用 Inode 表示文件、文件夹、符号链接。   

Inode 由 InodeId 和 InodeData 组成。  
InodeId 是 Inode 编号，具有唯一性；  
InodeData 保存文件的元数据，包括文件类型、访问权限、访问时间、修改时间、链接数等，如果是文件还包括大小、布局等信息。   

**DirEntry**  

**Layout**   
Linux 的元数据会存储指向文件数据的指针，用于定位文件数据。而 3FS 会将文件数据划分为大小相等的块，并条带化分布在在多个复制链上，因此定位数据块需要数据块大小、条带大小和链列表等元数据，这些元数据会保存在一个 Layout 结构中，Layout 就是 3FS 的数据指针。 

### 逻辑操作
处理文件元数据的操作，如创建、打开文件/文件夹、重命名等，只是在逻辑层面对文件进行重新组织，不影响数据的物理存储。  

逻辑操作会通过 FoundationDB 事务来实现，确保数据的一致性和原子性。 

**原子性保证**  
1、只读事务：用于元数据查询，如 stat、list 等操作。   
2、读写事务：用于元数据更新，如 create、rename、mkdirs 等操作。当检测到并发事务冲突时，元服务会自动重试事务，以保证文件系统元数据的一致性。  

### 文件系统语义
用户可以像操作本地文件系统一样操作分布式文件系统，用户只能感知到文件本身，而文件的存储方式和分布式实现是透明的。

## 块存储服务
负责实际文件数据的存储和管理，直接与物理存储设备 SSD 交互，为文件系统提供数据的持久化存储。

### 数据块存储
存储服务器管理着一个或者多个本地 SSD，SSD 上会创建一批物理文件（内部文件）用于存储数据块，物理文件是数据块的存储载体。  

### 读写操作

### 一致性保证
实现 Chain Replication with Apportioned Queries（CRAQ）协议，采用 “write-all-read-any” 的方法，确保数据的强一致性。这种方法有助于释放 SSD 和 RDMA 网络的吞吐量，提高文件系统的性能。

### 数据放置
放置策略：条带化和复制链。  
a   d   g
|   |   |
b   e   h
|   |   |
c   f   i

![CR 放置](../img/3fs_data_place.png "3fs placement")

**获取 ChainId**   
两种分配方式
一种是由配置管理服务分配；
另一种是通过算法分配，相同的块会分配到相同的复制链。

**获取 ChunkId**  
ChunkId = InodeId + ChunkIndex + TrackId。
TrackId 未使用，可以暂时忽略，ChunkId 可以看作由 InodeId 和 ChunkIndex 组成。

ChunkIndex = Offest / ChunkSize。

## 总结
3FS 分离了文件的逻辑结构和物理存储。文件的逻辑结构由元数据提供，表现为虚拟/逻辑文件——用户看到和操作的文件；物理存储由存储节点实现，载体是物理文件——SSD 上实际存在的文件，与逻辑文件概念相对应。